"""
页面逻辑模块

定义各个页面的业务逻辑和流程控制。
"""

import streamlit as st
import os
from typing import Optional, Dict, Any

from models.task_models import TaskAnalysis, Task, GenerationResult
from core.llm import analyze_tasks
from core.retrieval import generate_task_code, retrieval_manager
from core.multi_llm import multi_llm_manager
from ui.components import (
    FileUploadComponent, TaskAnalysisComponent, TaskEditComponent,
    GenerationResultComponent, ErrorDisplayComponent, SuccessDisplayComponent
)
from ui.model_selector import ModelSelectorComponent
from ui.model_config_flow import model_config_flow
from ui.custom_api_config import custom_api_config_ui
from config.settings import settings
from utils.validators import ValidationError


class MainPage:
    """主页面类"""

    def __init__(self):
        """初始化主页面"""
        self._init_session_state()

    def _init_session_state(self):
        """初始化会话状态"""
        if 'task_analysis' not in st.session_state:
            st.session_state.task_analysis = None
        if 'last_prompt' not in st.session_state:
            st.session_state.last_prompt = ""
        if 'last_response' not in st.session_state:
            st.session_state.last_response = ""
        if 'generation_results' not in st.session_state:
            st.session_state.generation_results = []

        # 确保API连接状态已初始化（避免在配置流程之前访问时报错）
        if 'api_connection_status' not in st.session_state:
            st.session_state.api_connection_status = {
                'analysis': {'connected': False, 'model': '', 'error': ''},
                'generation': {'connected': False, 'model': '', 'error': ''}
            }

        # 初始化模型选择器
        self.model_selector = ModelSelectorComponent()

    def _render_config_status_warnings(self):
        """渲染配置状态警告"""
        validation_status = settings.get_validation_status()

        # Tesseract警告
        if not validation_status["tesseract"]:
            st.warning("⚠️ **Tesseract OCR未配置**")
            st.info("💡 图片识别功能需要Tesseract OCR。请安装后设置环境变量 `TESSERACT_CMD`")
        else:
            st.success("✅ Tesseract OCR已配置")

        # API密钥信息（不再是警告，只是提示）
        if validation_status["has_any_api_key"]:
            configured_count = sum(1 for key in validation_status.get("api_keys", []) if key["has_key"])
            if configured_count > 0:
                st.success(f"✅ 已在环境变量中配置 {configured_count} 个AI模型")
        else:
            st.info("💡 **AI模型配置提示**")
            st.write("未在环境变量中检测到API密钥，您可以通过侧边栏配置任何支持的AI模型。")
            st.write("🔧 **支持的模型提供商包括：**")
            st.write("- Google Gemini, OpenAI, Anthropic Claude")
            st.write("- 阿里云通义千问, 百度文心一言, 智谱清言")
            st.write("- 月之暗面Kimi, DeepSeek, Mistral AI, Cohere")
            st.info("👉 请在侧边栏完成AI模型配置后开始使用")

    def _render_api_connection_status(self):
        """渲染API连接状态"""
        # 使用状态容器来显示连接状态
        with st.container():
            # 在页面顶部显示连接状态徽章
            col1, col2, col3 = st.columns([2, 1, 1])

            with col1:
                st.write("")  # 空列用于布局

            with col2:
                if model_config_flow.is_config_complete():
                    st.success("🟢 AI模型连接正常")
                else:
                    # 检查部分连接状态
                    analysis_connected = st.session_state.api_connection_status['analysis']['connected']
                    generation_connected = st.session_state.api_connection_status['generation']['connected']
                    if analysis_connected or generation_connected:
                        st.warning("🟡 部分AI模型连接异常")
                    else:
                        st.error("🔴 AI模型未连接")

            with col3:
                # 显示自定义API状态和重新配置按钮
                custom_configs = custom_api_manager.get_active_configs()
                if custom_configs:
                    st.info(f"🔧 {len(custom_configs)} 个自定义API")
                else:
                    st.write("")  # 空列用于布局

                if st.button("🔄 重新配置", help="重新配置AI模型", key="main_reconfigure"):
                    # 重置配置状态
                    st.session_state.api_connection_status = {
                        'analysis': {'connected': False, 'model': '', 'error': ''},
                        'generation': {'connected': False, 'model': '', 'error': ''}
                    }
                    st.rerun()

            # 显示详细连接信息（可折叠）
            if not model_config_flow.is_config_complete():
                with st.expander("📊 查看详细连接状态", expanded=False):
                    model_config_flow._display_connection_status()

    def render(self):
        """渲染主页面"""
        # 设置页面标题
        st.title("🤖 HSPICE RAG 代码生成助手")
        st.caption("上传实验截图，分析任务，生成HSPICE代码")

        # 显示配置状态提示
        self._render_config_status_warnings()

        # 显示API连接状态（所有模式下都显示）
        self._render_api_connection_status()

        # 模型配置部分（始终显示配置流程）
        with st.sidebar:
            # 添加自定义API配置入口
            st.markdown("---")
            if st.button("🔧 自定义API配置", help="配置自定义大模型API（类似Cherry Studio）",
                     use_container_width=True, type="secondary"):
                st.session_state.show_custom_api_config = True
                st.rerun()

            # 如果点击了自定义API配置，显示配置页面
            if st.session_state.get('show_custom_api_config', False):
                custom_api_config_ui.render_config_page()
                if st.button("🔙 返回主配置", key="back_to_main_config"):
                    st.session_state.show_custom_api_config = False
                    st.rerun()
                return

            # 使用新的配置流程
            config_complete = model_config_flow.render_config_flow()

            if not config_complete:
                st.warning("⚠️ 请完成AI模型配置和连接测试")
                st.info("💡 配置完成后系统将自动刷新页面")
                return

            # 获取模型配置
            model_configs = model_config_flow.get_current_config()
            analysis_model_id, analysis_api_key = model_configs['analysis']
            generation_model_id, generation_api_key = model_configs['generation']

            # 保存当前模型配置到会话状态
            st.session_state.analysis_model_id = analysis_model_id
            st.session_state.analysis_api_key = analysis_api_key
            st.session_state.generation_model_id = generation_model_id
            st.session_state.generation_api_key = generation_api_key

        # 第一部分：文件上传和文本提取
        self._render_file_upload_section()

        # 添加分隔线
        st.divider()

        # 第二部分：任务编辑与代码生成
        self._render_task_edit_section()

    def _render_file_upload_section(self):
        """渲染文件上传部分"""
        st.subheader("1. 上传实验要求文件")

        # 文件上传
        upload_component = FileUploadComponent()
        uploaded_file = upload_component.render_file_upload(
            "选择包含实验要求的文件",
            ["png", "jpg", "jpeg", "pdf"],
            "支持图片文件用于OCR识别，或PDF文件直接提取文本"
        )

        extracted_text = ""
        if uploaded_file:
            try:
                extracted_text = upload_component.display_uploaded_file(uploaded_file)
                
                # ===============================================================
                # START: 核心修改部分
                # ---------------------------------------------------------------
                # 错误代码 (已注释掉):
                # upload_component.render_extracted_text(extracted_text)
                
                # 正确代码:
                # 创建一个 TaskAnalysisComponent 实例来调用其 render_extracted_text 方法
                analysis_component = TaskAnalysisComponent()
                analysis_component.render_extracted_text(extracted_text)
                # ---------------------------------------------------------------
                # END: 核心修改部分
                # ===============================================================

            except Exception as e:
                ErrorDisplayComponent.render_error("文件处理失败", e)

        # 任务分析
        if extracted_text:
            self._handle_task_analysis(extracted_text)

    def _handle_task_analysis(self, extracted_text: str):
        """处理任务分析"""
        analysis_component = TaskAnalysisComponent()

        if analysis_component.render_analyze_button(extracted_text):
            with st.spinner("AI分析任务中..."):
                try:
                    # 验证输入
                    if not extracted_text.strip():
                        st.warning("OCR结果为空，请检查文件或重新上传")
                        return

                    # 获取任务分析模型配置
                    analysis_model_id = st.session_state.get('analysis_model_id', settings.DEFAULT_MODEL)
                    analysis_api_key = st.session_state.get('analysis_api_key', '')

                    if not analysis_api_key:
                        st.error("❌ 未配置任务分析模型API密钥，请先在侧边栏配置AI模型")
                        return

                    # 执行任务分析（使用任务分析模型）
                    task_analysis_dict = multi_llm_manager.analyze_tasks(
                        analysis_model_id, analysis_api_key, extracted_text
                    )

                    # 转换为TaskAnalysis对象
                    task_analysis = TaskAnalysis.from_dict(task_analysis_dict)

                    # 保存到会话状态
                    st.session_state.task_analysis = task_analysis
                    SuccessDisplayComponent.render_success("任务分析完成！")

                    # 显示分析结果
                    analysis_component.render_task_analysis_result(task_analysis)

                    # 显示调试信息
                    if hasattr(st.session_state, 'last_prompt') and hasattr(st.session_state, 'last_response'):
                        analysis_component.render_debug_info(
                            st.session_state.last_prompt,
                            st.session_state.last_response
                        )

                except ValidationError as e:
                    ErrorDisplayComponent.render_validation_error(e)
                except Exception as e:
                    ErrorDisplayComponent.render_error("任务分析失败", e)

                    # 显示调试信息
                    if hasattr(st.session_state, 'last_prompt'):
                        analysis_component.render_debug_info(
                            st.session_state.last_prompt,
                            getattr(st.session_state, 'last_response', '无响应数据')
                        )

    def _render_task_edit_section(self):
        """渲染任务编辑部分"""
        st.subheader("2. 任务编辑与代码生成")

        if st.session_state.task_analysis is None:
            SuccessDisplayComponent.render_info("请先上传文件并进行任务分析")
            return

        task_analysis = st.session_state.task_analysis

        # 显示分析结果
        analysis_component = TaskAnalysisComponent()
        analysis_component.render_task_analysis_result(task_analysis)

        # 编辑总体描述
        edit_component = TaskEditComponent()
        general_description = edit_component.render_general_description_edit(
            task_analysis.general_description
        )

        # 编辑任务列表
        tasks = edit_component.render_task_list(task_analysis.tasks)

        # 检查是否有生成请求
        self._check_generation_requests(tasks)

        # 处理添加任务
        if tasks:
            if edit_component.render_add_task_button():
                new_task_id = task_analysis.get_next_task_id()
                new_task = Task(
                    id=new_task_id,
                    title=f"任务{new_task_id}.sp",
                    description="新添加的HSPICE仿真任务描述"
                )
                task_analysis.add_task(new_task)
                st.session_state.task_analysis = task_analysis
                st.rerun()
        else:
            if edit_component.render_add_first_task_button():
                new_task = Task(
                    id=1,
                    title="任务1.sp",
                    description="新添加的HSPICE仿真任务描述"
                )
                task_analysis.add_task(new_task)
                st.session_state.task_analysis = task_analysis
                st.rerun()

        # 保存编辑结果
        if edit_component.render_save_button():
            task_analysis.general_description = general_description
            task_analysis.tasks = tasks
            st.session_state.task_analysis = task_analysis
            SuccessDisplayComponent.render_success("任务分析已更新")

    def _check_generation_requests(self, tasks: list):
        """检查并处理代码生成请求"""
        edit_component = TaskEditComponent()
        result_component = GenerationResultComponent()

        for i, task in enumerate(tasks):
            # 检查是否有生成请求
            generate_key = f"generate_task_{i}_data"
            if generate_key in st.session_state:
                task_to_generate = st.session_state[generate_key]
                del st.session_state[generate_key]  # 清除请求标记

                # 生成代码
                self._generate_code_for_task(task_to_generate)

    def _generate_code_for_task(self, task: Task):
        """为单个任务生成代码"""
        with st.spinner(f"正在生成 {task.title} 的HSPICE代码..."):
            try:
                # 获取总体描述
                general_description = st.session_state.task_analysis.general_description

                # 获取代码生成模型配置
                generation_model_id = st.session_state.get('generation_model_id', settings.DEFAULT_MODEL)
                generation_api_key = st.session_state.get('generation_api_key', '')

                if not generation_api_key:
                    st.error("❌ 未配置代码生成模型API密钥，请先在侧边栏配置AI模型")
                    return

                # 生成代码
                result_dict = retrieval_manager.generate_single_task_code(
                    task=task.to_dict(),
                    general_description=general_description,
                    visual_info=task.visual_info,
                    model_id=generation_model_id,
                    api_key=generation_api_key
                )

                # 创建结果对象
                result = GenerationResult(
                    task_id=result_dict["task_id"],
                    title=result_dict["title"],
                    description=result_dict["description"],
                    analysis=result_dict.get("analysis", ""),
                    hspice_code=result_dict.get("hspice_code", ""),
                    error=result_dict.get("error", ""),
                    success=result_dict.get("success", True)
                )

                # 显示结果
                result_component = GenerationResultComponent() # 修正：这里也需要实例化
                result_component.render_generation_result(result)

                # 保存结果到会话状态
                if 'generation_results' not in st.session_state:
                    st.session_state.generation_results = []
                st.session_state.generation_results.append(result)

            except Exception as e:
                ErrorDisplayComponent.render_error(f"调用AI失败", e)


class TaskAnalysisPage:
    """任务分析页面（备用）"""

    @staticmethod
    def render():
        """渲染任务分析页面"""
        st.title("📋 任务分析")
        st.write("此页面用于单独的任务分析功能")


class SettingsPage:
    """设置页面（备用）"""

    @staticmethod
    def render():
        """渲染设置页面"""
        st.title("⚙️ 设置")
        st.write("此页面用于系统配置")


class PageRouter:
    """页面路由器"""

    @staticmethod
    def render_page(page_name: str = "main"):
        """
        根据页面名称渲染对应页面

        Args:
            page_name: 页面名称
        """
        if page_name == "main":
            main_page = MainPage()
            main_page.render()
        elif page_name == "task_analysis":
            TaskAnalysisPage.render()
        elif page_name == "settings":
            SettingsPage.render()
        else:
            st.error(f"未知页面: {page_name}")
            MainPage().render()


# 便捷函数
def render_main_page():
    """渲染主页面"""
    main_page = MainPage()
    main_page.render()


def render_page_with_sidebar():
    """渲染带侧边栏的页面"""
    with st.sidebar:
        st.title("🧭 导航")
        page_selection = st.selectbox(
            "选择页面",
            ["主页", "任务分析", "设置"],
            index=0
        )

        page_map = {
            "主页": "main",
            "任务分析": "task_analysis",
            "设置": "settings"
        }

        selected_page = page_map.get(page_selection, "main")

    # 渲染选中的页面
    PageRouter.render_page(selected_page)